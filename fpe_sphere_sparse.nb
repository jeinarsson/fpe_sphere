(* Content-type: application/vnd.wolfram.mathematica *)

(*** Wolfram Notebook File ***)
(* http://www.wolfram.com/nb *)

(* CreatedBy='Mathematica 9.0' *)

(*CacheID: 234*)
(* Internal cache information:
NotebookFileLineBreakTest
NotebookFileLineBreakTest
NotebookDataPosition[       157,          7]
NotebookDataLength[     56792,       1467]
NotebookOptionsPosition[     55325,       1414]
NotebookOutlinePosition[     55693,       1430]
CellTagsIndexPosition[     55650,       1427]
WindowFrame->Normal*)

(* Beginning of Notebook Content *)
Notebook[{

Cell[CellGroupData[{
Cell["\<\
Assemble sparse matrices from the matrix elements\
\>", "Title",
 CellChangeTimes->{{3.5792723741939163`*^9, 3.579272381921358*^9}}],

Cell["\<\
Two different types of matrices are assembled:
1. The full matrix, all l,m included. This is used for time-dependent \
solutions.
2. The augmented matrix, only even l,m (due to symmetries in the Jeffery \
equations), and the l=0 mode removed and moved to the right hand side, such \
that the matrix equation is actually invertible.\
\>", "Subsubtitle",
 CellChangeTimes->{{3.5792725236964674`*^9, 3.579272612112524*^9}}],

Cell["\<\
NOTE: The optimizations in here are true not in general.
Even l,m : Due to symmetries in the Jeffery problem in shear flow
Conjugate matrixelementns upon \[CapitalDelta]m->-\[CapitalDelta]m because P \
is real-valued\
\>", "Text",
 CellChangeTimes->{{3.5792729193900995`*^9, 3.579273009413248*^9}, {
  3.5792730593971076`*^9, 3.579273071564803*^9}}],

Cell[CellGroupData[{

Cell["\<\
Matrix elements (taken from previous notebook)\
\>", "Section",
 CellChangeTimes->{{3.5792726197129593`*^9, 3.5792726295995245`*^9}}],

Cell["\<\
These are the matrix elements from the previous file, just copied and pasted.\
\>", "Text",
 CellChangeTimes->{{3.5792724791689205`*^9, 3.579272492696694*^9}}],

Cell[BoxData[
 RowBox[{"matrixelements", "=", 
  RowBox[{"{", 
   RowBox[{
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "2"}], ",", "0"}], "}"}], ",", 
      TagBox[GridBox[{
         {"\[Piecewise]", GridBox[{
            {"0", 
             RowBox[{
              RowBox[{"l", "<", "2"}], "||", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"l", "\[GreaterEqual]", 
                   RowBox[{"2", "+", "m"}]}], "||", 
                  RowBox[{
                   RowBox[{"l", "+", "m"}], "\[LessEqual]", "1"}]}], ")"}], "&&", 
                RowBox[{"m", "\[GreaterEqual]", "0"}]}], ")"}], "||", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"m", "<", "0"}], "&&", 
                RowBox[{
                 RowBox[{"l", "+", "m"}], "\[GreaterEqual]", "2"}]}], ")"}]}]},
            {
             RowBox[{
              FractionBox["1", "2"], " ", "\[ImaginaryI]", " ", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "1"}], "+", "l"}], ")"}], " ", "m", " ", 
              SqrtBox[
               FractionBox[
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "1"}], "+", "l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "1"}], "+", "l", "+", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"l", "+", "m"}], ")"}]}], 
                RowBox[{
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{"1", "-", 
                    RowBox[{"2", " ", "l"}]}], ")"}], "2"], " ", 
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "l"}], ")"}], "2"], " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "3"}], "+", 
                   RowBox[{"2", " ", "l"}]}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"1", "+", 
                   RowBox[{"2", " ", "l"}]}], ")"}]}]]]}], 
             RowBox[{
              RowBox[{"l", ">", 
               RowBox[{"1", "+", "m"}]}], "&&", 
              RowBox[{
               RowBox[{"l", "+", "m"}], ">", "1"}]}]},
            {
             FractionBox[
              RowBox[{"\[ImaginaryI]", " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "2"}], "+", "l", "-", "m"}], ")"}], " ", 
               SqrtBox[
                FractionBox[
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "+", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"l", "+", "m"}], ")"}]}], 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "3"}], "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"1", "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}]}]]]}], 
              RowBox[{
               RowBox[{"-", "4"}], "+", 
               RowBox[{"8", " ", "l"}]}]], 
             RowBox[{
              RowBox[{"l", "\[GreaterEqual]", "2"}], "&&", 
              RowBox[{
               RowBox[{"l", "+", "m"}], ">", "1"}]}]},
            {
             FractionBox[
              RowBox[{
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "2"}], "+", "l", "+", "m"}], ")"}], " ", 
               SqrtBox[
                RowBox[{"-", 
                 FractionBox[
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "-", "m"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{"l", "-", "m"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "+", "m"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{"l", "+", "m"}], ")"}]}], 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "3"}], "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{"1", "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}]}]]}]]}], 
              RowBox[{
               RowBox[{"-", "4"}], "+", 
               RowBox[{"8", " ", "l"}]}]], 
             TagBox["True",
              "PiecewiseDefault",
              AutoDelete->True]}
           },
           AllowedDimensions->{2, Automatic},
           Editable->True,
           
           GridBoxAlignment->{
            "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
             "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
           
           GridBoxItemSize->{
            "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, 
             "Rows" -> {{1.}}, "RowsIndexed" -> {}},
           GridBoxSpacings->{"Columns" -> {
               Offset[0.27999999999999997`], {
                Offset[0.84]}, 
               Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
               Offset[0.2], {
                Offset[0.4]}, 
               Offset[0.2]}, "RowsIndexed" -> {}},
           Selectable->True]}
        },
        GridBoxAlignment->{
         "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
          "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
        GridBoxItemSize->{
         "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, "Rows" -> {{1.}},
           "RowsIndexed" -> {}},
        GridBoxSpacings->{"Columns" -> {
            Offset[0.27999999999999997`], {
             Offset[0.35]}, 
            Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
            Offset[0.2], {
             Offset[0.4]}, 
            Offset[0.2]}, "RowsIndexed" -> {}}],
       "Piecewise",
       DeleteWithContents->True,
       Editable->False,
       SelectWithContents->True,
       Selectable->False]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "2"}], ",", "2"}], "}"}], ",", 
      TagBox[GridBox[{
         {"\[Piecewise]", GridBox[{
            {
             FractionBox[
              RowBox[{"\[ImaginaryI]", " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "2"}], "+", "l"}], ")"}], " ", 
               SqrtBox[
                FractionBox[
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "3"}], "+", "l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "2"}], "+", "l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"l", "-", "m"}], ")"}]}], 
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "3"}], "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"1", "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}]}]]], " ", 
               "\[CapitalLambda]"}], 
              RowBox[{
               RowBox[{"-", "4"}], "+", 
               RowBox[{"8", " ", "l"}]}]], 
             RowBox[{
              RowBox[{"l", "\[GreaterEqual]", "2"}], "&&", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"l", "\[GreaterEqual]", 
                 RowBox[{"4", "+", "m"}]}], "||", 
                RowBox[{"m", "<", 
                 RowBox[{"-", "2"}]}]}], ")"}]}]},
            {
             RowBox[{
              FractionBox["1", "4"], " ", "\[ImaginaryI]", " ", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"-", "1"}], "+", "l"}], ")"}], " ", 
              SqrtBox[
               FractionBox[
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "3"}], "+", "l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "2"}], "+", "l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "1"}], "+", "l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"l", "-", "m"}], ")"}], " ", 
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{"l", "+", "m"}], ")"}], "2"]}], 
                RowBox[{
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{"1", "-", 
                    RowBox[{"2", " ", "l"}]}], ")"}], "2"], " ", 
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "l"}], ")"}], "2"], " ", 
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "3"}], "+", 
                   RowBox[{"2", " ", "l"}]}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"1", "+", 
                   RowBox[{"2", " ", "l"}]}], ")"}]}]]], " ", 
              "\[CapitalLambda]"}], 
             RowBox[{"l", ">", 
              RowBox[{"3", "+", "m"}]}]},
            {"0", 
             TagBox["True",
              "PiecewiseDefault",
              AutoDelete->True]}
           },
           AllowedDimensions->{2, Automatic},
           Editable->True,
           
           GridBoxAlignment->{
            "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
             "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
           
           GridBoxItemSize->{
            "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, 
             "Rows" -> {{1.}}, "RowsIndexed" -> {}},
           GridBoxSpacings->{"Columns" -> {
               Offset[0.27999999999999997`], {
                Offset[0.84]}, 
               Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
               Offset[0.2], {
                Offset[0.4]}, 
               Offset[0.2]}, "RowsIndexed" -> {}},
           Selectable->True]}
        },
        GridBoxAlignment->{
         "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
          "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
        GridBoxItemSize->{
         "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, "Rows" -> {{1.}},
           "RowsIndexed" -> {}},
        GridBoxSpacings->{"Columns" -> {
            Offset[0.27999999999999997`], {
             Offset[0.35]}, 
            Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
            Offset[0.2], {
             Offset[0.4]}, 
            Offset[0.2]}, "RowsIndexed" -> {}}],
       "Piecewise",
       DeleteWithContents->True,
       Editable->False,
       SelectWithContents->True,
       Selectable->False]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0", ",", "0"}], "}"}], ",", 
      TagBox[GridBox[{
         {"\[Piecewise]", GridBox[{
            {
             RowBox[{
              RowBox[{
               RowBox[{"-", "invPe"}], " ", "l", " ", 
               RowBox[{"(", 
                RowBox[{"1", "+", "l"}], ")"}]}], "+", 
              FractionBox[
               RowBox[{"\[ImaginaryI]", " ", "m"}], "3"]}], 
             RowBox[{"l", "<", "1"}]},
            {
             RowBox[{
              RowBox[{
               RowBox[{"-", "invPe"}], " ", "l", " ", 
               RowBox[{"(", 
                RowBox[{"1", "+", "l"}], ")"}]}], "+", 
              FractionBox[
               RowBox[{"\[ImaginaryI]", " ", "m"}], "2"]}], 
             TagBox["True",
              "PiecewiseDefault",
              AutoDelete->True]}
           },
           AllowedDimensions->{2, Automatic},
           Editable->True,
           
           GridBoxAlignment->{
            "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
             "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
           
           GridBoxItemSize->{
            "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, 
             "Rows" -> {{1.}}, "RowsIndexed" -> {}},
           GridBoxSpacings->{"Columns" -> {
               Offset[0.27999999999999997`], {
                Offset[0.84]}, 
               Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
               Offset[0.2], {
                Offset[0.4]}, 
               Offset[0.2]}, "RowsIndexed" -> {}},
           Selectable->True]}
        },
        GridBoxAlignment->{
         "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
          "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
        GridBoxItemSize->{
         "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, "Rows" -> {{1.}},
           "RowsIndexed" -> {}},
        GridBoxSpacings->{"Columns" -> {
            Offset[0.27999999999999997`], {
             Offset[0.35]}, 
            Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
            Offset[0.2], {
             Offset[0.4]}, 
            Offset[0.2]}, "RowsIndexed" -> {}}],
       "Piecewise",
       DeleteWithContents->True,
       Editable->False,
       SelectWithContents->True,
       Selectable->False]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0", ",", "2"}], "}"}], ",", 
      TagBox[GridBox[{
         {"\[Piecewise]", GridBox[{
            {
             RowBox[{
              FractionBox["3", "4"], " ", "\[ImaginaryI]", " ", 
              RowBox[{"(", 
               RowBox[{"1", "+", "l"}], ")"}], " ", 
              SqrtBox[
               FractionBox[
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "1"}], "+", "l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"1", "+", "l", "+", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"2", "+", "l", "+", "m"}], ")"}]}], 
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "3"}], "+", 
                   RowBox[{"l", " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "+", 
                    RowBox[{"4", " ", "l", " ", 
                    RowBox[{"(", 
                    RowBox[{"2", "+", "l"}], ")"}]}]}], ")"}]}]}], ")"}], 
                 "2"]]], " ", "\[CapitalLambda]"}], 
             RowBox[{
              RowBox[{"l", "\[GreaterEqual]", "1"}], "&&", 
              RowBox[{"(", 
               RowBox[{
                RowBox[{"l", "\[GreaterEqual]", 
                 RowBox[{"2", "+", "m"}]}], "||", 
                RowBox[{"m", "<", 
                 RowBox[{"-", "2"}]}]}], ")"}]}]},
            {
             RowBox[{
              RowBox[{"-", 
               FractionBox["1", "4"]}], " ", "\[ImaginaryI]", " ", 
              RowBox[{"(", 
               RowBox[{"1", "+", "l"}], ")"}], " ", 
              SqrtBox[
               FractionBox[
                RowBox[{
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "1"}], "+", "l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"l", "-", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"1", "+", "l", "+", "m"}], ")"}], " ", 
                 RowBox[{"(", 
                  RowBox[{"2", "+", "l", "+", "m"}], ")"}]}], 
                SuperscriptBox[
                 RowBox[{"(", 
                  RowBox[{
                   RowBox[{"-", "3"}], "+", 
                   RowBox[{"l", " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "+", 
                    RowBox[{"4", " ", "l", " ", 
                    RowBox[{"(", 
                    RowBox[{"2", "+", "l"}], ")"}]}]}], ")"}]}]}], ")"}], 
                 "2"]]], " ", 
              RowBox[{"(", 
               RowBox[{"1", "+", 
                RowBox[{"2", " ", "m"}]}], ")"}], " ", "\[CapitalLambda]"}], 
             RowBox[{"l", ">", 
              RowBox[{"1", "+", "m"}]}]},
            {"0", 
             TagBox["True",
              "PiecewiseDefault",
              AutoDelete->True]}
           },
           AllowedDimensions->{2, Automatic},
           Editable->True,
           
           GridBoxAlignment->{
            "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
             "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
           
           GridBoxItemSize->{
            "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, 
             "Rows" -> {{1.}}, "RowsIndexed" -> {}},
           GridBoxSpacings->{"Columns" -> {
               Offset[0.27999999999999997`], {
                Offset[0.84]}, 
               Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
               Offset[0.2], {
                Offset[0.4]}, 
               Offset[0.2]}, "RowsIndexed" -> {}},
           Selectable->True]}
        },
        GridBoxAlignment->{
         "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
          "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
        GridBoxItemSize->{
         "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, "Rows" -> {{1.}},
           "RowsIndexed" -> {}},
        GridBoxSpacings->{"Columns" -> {
            Offset[0.27999999999999997`], {
             Offset[0.35]}, 
            Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
            Offset[0.2], {
             Offset[0.4]}, 
            Offset[0.2]}, "RowsIndexed" -> {}}],
       "Piecewise",
       DeleteWithContents->True,
       Editable->False,
       SelectWithContents->True,
       Selectable->False]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"2", ",", "2"}], "}"}], ",", 
      RowBox[{"-", 
       FractionBox[
        RowBox[{"\[ImaginaryI]", " ", 
         RowBox[{"(", 
          RowBox[{"3", "+", "l"}], ")"}], " ", 
         SqrtBox[
          FractionBox[
           RowBox[{
            RowBox[{"(", 
             RowBox[{"1", "+", "l", "+", "m"}], ")"}], " ", 
            RowBox[{"(", 
             RowBox[{"2", "+", "l", "+", "m"}], ")"}], " ", 
            RowBox[{"(", 
             RowBox[{"3", "+", "l", "+", "m"}], ")"}], " ", 
            RowBox[{"(", 
             RowBox[{"4", "+", "l", "+", "m"}], ")"}]}], 
           RowBox[{"5", "+", 
            RowBox[{"12", " ", "l"}], "+", 
            RowBox[{"4", " ", 
             SuperscriptBox["l", "2"]}]}]]], " ", "\[CapitalLambda]"}], 
        RowBox[{"12", "+", 
         RowBox[{"8", " ", "l"}]}]]}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
        RowBox[{"-", "2"}], ",", 
        RowBox[{"-", "2"}]}], "}"}], ",", 
      RowBox[{"Conjugate", "[", 
       TagBox[GridBox[{
          {"\[Piecewise]", GridBox[{
             {
              FractionBox[
               RowBox[{"\[ImaginaryI]", " ", 
                RowBox[{"(", 
                 RowBox[{
                  RowBox[{"-", "2"}], "+", "l"}], ")"}], " ", 
                SqrtBox[
                 FractionBox[
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "3"}], "+", "l", "+", "m"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "2"}], "+", "l", "+", "m"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "+", "m"}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{"l", "+", "m"}], ")"}]}], 
                  RowBox[{
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "3"}], "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}], " ", 
                   RowBox[{"(", 
                    RowBox[{"1", "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}]}]]], " ", 
                "\[CapitalLambda]"}], 
               RowBox[{
                RowBox[{"-", "4"}], "+", 
                RowBox[{"8", " ", "l"}]}]], 
              RowBox[{
               RowBox[{"l", "\[GreaterEqual]", "2"}], "&&", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"l", "+", "m"}], "\[GreaterEqual]", "4"}], "||", 
                 RowBox[{"m", ">", "2"}]}], ")"}]}]},
             {
              RowBox[{
               FractionBox["1", "4"], " ", "\[ImaginaryI]", " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "1"}], "+", "l"}], ")"}], " ", 
               SqrtBox[
                FractionBox[
                 RowBox[{
                  SuperscriptBox[
                   RowBox[{"(", 
                    RowBox[{"l", "-", "m"}], ")"}], "2"], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "3"}], "+", "l", "+", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "2"}], "+", "l", "+", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "+", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"l", "+", "m"}], ")"}]}], 
                 RowBox[{
                  SuperscriptBox[
                   RowBox[{"(", 
                    RowBox[{"1", "-", 
                    RowBox[{"2", " ", "l"}]}], ")"}], "2"], " ", 
                  SuperscriptBox[
                   RowBox[{"(", 
                    RowBox[{
                    RowBox[{"-", "1"}], "+", "l"}], ")"}], "2"], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "3"}], "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"1", "+", 
                    RowBox[{"2", " ", "l"}]}], ")"}]}]]], " ", 
               "\[CapitalLambda]"}], 
              RowBox[{
               RowBox[{"l", "+", "m"}], ">", "3"}]},
             {"0", 
              TagBox["True",
               "PiecewiseDefault",
               AutoDelete->True]}
            },
            AllowedDimensions->{2, Automatic},
            Editable->True,
            
            GridBoxAlignment->{
             "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
              "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
            
            GridBoxItemSize->{
             "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, 
              "Rows" -> {{1.}}, "RowsIndexed" -> {}},
            GridBoxSpacings->{"Columns" -> {
                Offset[0.27999999999999997`], {
                 Offset[0.84]}, 
                Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
                Offset[0.2], {
                 Offset[0.4]}, 
                Offset[0.2]}, "RowsIndexed" -> {}},
            Selectable->True]}
         },
         GridBoxAlignment->{
          "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
           "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
         GridBoxItemSize->{
          "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, 
           "Rows" -> {{1.}}, "RowsIndexed" -> {}},
         GridBoxSpacings->{"Columns" -> {
             Offset[0.27999999999999997`], {
              Offset[0.35]}, 
             Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
             Offset[0.2], {
              Offset[0.4]}, 
             Offset[0.2]}, "RowsIndexed" -> {}}],
        "Piecewise",
        DeleteWithContents->True,
        Editable->False,
        SelectWithContents->True,
        Selectable->False], "]"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"0", ",", 
        RowBox[{"-", "2"}]}], "}"}], ",", 
      RowBox[{"Conjugate", "[", 
       TagBox[GridBox[{
          {"\[Piecewise]", GridBox[{
             {
              RowBox[{
               FractionBox["3", "4"], " ", "\[ImaginaryI]", " ", 
               RowBox[{"(", 
                RowBox[{"1", "+", "l"}], ")"}], " ", 
               SqrtBox[
                FractionBox[
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"1", "+", "l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"2", "+", "l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "+", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"l", "+", "m"}], ")"}]}], 
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "3"}], "+", 
                    RowBox[{"l", " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "+", 
                    RowBox[{"4", " ", "l", " ", 
                    RowBox[{"(", 
                    RowBox[{"2", "+", "l"}], ")"}]}]}], ")"}]}]}], ")"}], 
                  "2"]]], " ", "\[CapitalLambda]"}], 
              RowBox[{
               RowBox[{"l", "\[GreaterEqual]", "1"}], "&&", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{
                  RowBox[{"l", "+", "m"}], "\[GreaterEqual]", "2"}], "||", 
                 RowBox[{"m", ">", "2"}]}], ")"}]}]},
             {
              RowBox[{
               FractionBox["1", "4"], " ", "\[ImaginaryI]", " ", 
               RowBox[{"(", 
                RowBox[{"1", "+", "l"}], ")"}], " ", 
               SqrtBox[
                FractionBox[
                 RowBox[{
                  RowBox[{"(", 
                   RowBox[{"1", "+", "l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"2", "+", "l", "-", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "1"}], "+", "l", "+", "m"}], ")"}], " ", 
                  RowBox[{"(", 
                   RowBox[{"l", "+", "m"}], ")"}]}], 
                 SuperscriptBox[
                  RowBox[{"(", 
                   RowBox[{
                    RowBox[{"-", "3"}], "+", 
                    RowBox[{"l", " ", 
                    RowBox[{"(", 
                    RowBox[{"1", "+", 
                    RowBox[{"4", " ", "l", " ", 
                    RowBox[{"(", 
                    RowBox[{"2", "+", "l"}], ")"}]}]}], ")"}]}]}], ")"}], 
                  "2"]]], " ", 
               RowBox[{"(", 
                RowBox[{
                 RowBox[{"-", "1"}], "+", 
                 RowBox[{"2", " ", "m"}]}], ")"}], " ", "\[CapitalLambda]"}], 
              RowBox[{
               RowBox[{"l", "+", "m"}], ">", "1"}]},
             {"0", 
              TagBox["True",
               "PiecewiseDefault",
               AutoDelete->True]}
            },
            AllowedDimensions->{2, Automatic},
            Editable->True,
            
            GridBoxAlignment->{
             "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
              "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
            
            GridBoxItemSize->{
             "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, 
              "Rows" -> {{1.}}, "RowsIndexed" -> {}},
            GridBoxSpacings->{"Columns" -> {
                Offset[0.27999999999999997`], {
                 Offset[0.84]}, 
                Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
                Offset[0.2], {
                 Offset[0.4]}, 
                Offset[0.2]}, "RowsIndexed" -> {}},
            Selectable->True]}
         },
         GridBoxAlignment->{
          "Columns" -> {{Left}}, "ColumnsIndexed" -> {}, 
           "Rows" -> {{Baseline}}, "RowsIndexed" -> {}},
         GridBoxItemSize->{
          "Columns" -> {{Automatic}}, "ColumnsIndexed" -> {}, 
           "Rows" -> {{1.}}, "RowsIndexed" -> {}},
         GridBoxSpacings->{"Columns" -> {
             Offset[0.27999999999999997`], {
              Offset[0.35]}, 
             Offset[0.27999999999999997`]}, "ColumnsIndexed" -> {}, "Rows" -> {
             Offset[0.2], {
              Offset[0.4]}, 
             Offset[0.2]}, "RowsIndexed" -> {}}],
        "Piecewise",
        DeleteWithContents->True,
        Editable->False,
        SelectWithContents->True,
        Selectable->False], "]"}]}], "}"}], ",", 
    RowBox[{"{", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{"2", ",", 
        RowBox[{"-", "2"}]}], "}"}], ",", 
      FractionBox[
       RowBox[{"\[ImaginaryI]", " ", 
        RowBox[{"(", 
         RowBox[{"3", "+", "l"}], ")"}], " ", 
        SqrtBox[
         FractionBox[
          RowBox[{
           RowBox[{"(", 
            RowBox[{"1", "+", "l", "-", "m"}], ")"}], " ", 
           RowBox[{"(", 
            RowBox[{"2", "+", "l", "-", "m"}], ")"}], " ", 
           RowBox[{"(", 
            RowBox[{"3", "+", "l", "-", "m"}], ")"}], " ", 
           RowBox[{"(", 
            RowBox[{"4", "+", "l", "-", "m"}], ")"}]}], 
          RowBox[{"5", "+", 
           RowBox[{"12", " ", "l"}], "+", 
           RowBox[{"4", " ", 
            SuperscriptBox["l", "2"]}]}]]], " ", "\[CapitalLambda]"}], 
       RowBox[{"12", "+", 
        RowBox[{"8", " ", "l"}]}]]}], "}"}]}], "}"}]}]], "Input",
 CellChangeTimes->{{3.579272469789384*^9, 3.5792724751236887`*^9}, 
   3.5792752845133767`*^9}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Complete matrix, all modes", "Section",
 CellChangeTimes->{{3.5792726367839355`*^9, 3.5792726492316475`*^9}}],

Cell[BoxData[
 RowBox[{
  RowBox[{
   RowBox[{"assemblesparse", "[", "maxl_", "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", 
      RowBox[{
      "row", ",", "p", ",", "q", ",", "col", ",", "dl", ",", "dm", ",", "l2", 
       ",", "m2", ",", "sparserules", ",", "value", ",", "size", ",", "k", 
       ",", "delta"}], "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"size", " ", "=", " ", 
       RowBox[{"Sum", "[", 
        RowBox[{
         RowBox[{
          RowBox[{"2", " ", "l"}], "+", "1"}], ",", 
         RowBox[{"{", 
          RowBox[{"l", ",", "0", ",", "maxl"}], "}"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"Print", "[", "size", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"row", "=", "1"}], ";", "\[IndentingNewLine]", 
      RowBox[{"sparserules", "=", 
       RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
      RowBox[{"For", "[", 
       RowBox[{
        RowBox[{"p", "=", "0"}], ",", 
        RowBox[{"p", "<=", "maxl"}], ",", 
        RowBox[{"p", "++"}], ",", "\[IndentingNewLine]", 
        RowBox[{"For", "[", 
         RowBox[{
          RowBox[{"q", "=", 
           RowBox[{"-", "p"}]}], ",", 
          RowBox[{"q", "\[LessEqual]", "p"}], ",", 
          RowBox[{"q", "++"}], ",", "\[IndentingNewLine]", 
          RowBox[{
           RowBox[{
            RowBox[{"For", "[", 
             RowBox[{
              RowBox[{"k", "=", "1"}], ",", 
              RowBox[{"k", "\[LessEqual]", 
               RowBox[{"Length", "[", "matrixelements", "]"}]}], ",", 
              RowBox[{"k", "++"}], ",", "\[IndentingNewLine]", 
              RowBox[{
               RowBox[{"delta", "=", 
                RowBox[{"matrixelements", "[", 
                 RowBox[{"[", 
                  RowBox[{"k", ",", "1"}], "]"}], "]"}]}], ";", 
               "\[IndentingNewLine]", 
               RowBox[{"dl", "=", 
                RowBox[{"delta", "[", 
                 RowBox[{"[", "1", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"dm", "=", 
                RowBox[{"delta", "[", 
                 RowBox[{"[", "2", "]"}], "]"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"l2", "=", 
                RowBox[{"p", "-", "dl"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"m2", " ", "=", " ", 
                RowBox[{"q", "-", "dm"}]}], ";", "\[IndentingNewLine]", 
               RowBox[{"If", " ", "[", 
                RowBox[{
                 RowBox[{
                  RowBox[{"l2", "\[GreaterEqual]", "0"}], " ", "&&", " ", 
                  RowBox[{"l2", "\[LessEqual]", "maxl"}], "&&", 
                  RowBox[{
                   RowBox[{"Abs", "[", "m2", "]"}], "\[LessEqual]", "l2"}]}], 
                 ",", "\[IndentingNewLine]", 
                 RowBox[{
                  RowBox[{"col", " ", "=", " ", 
                   RowBox[{"1", "+", 
                    RowBox[{"l2", 
                    RowBox[{"(", 
                    RowBox[{"l2", "+", "1"}], ")"}]}], "+", "m2"}]}], ";", 
                  "\[IndentingNewLine]", 
                  RowBox[{"value", "=", 
                   RowBox[{"Simplify", "[", " ", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"matrixelements", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "2"}], "]"}], "]"}], "/.", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"l", "\[Rule]", "l2"}], ",", 
                    RowBox[{"m", "\[Rule]", "m2"}]}], "}"}]}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    "\[CapitalLambda]", ",", "stEff", ",", "l", ",", "m", ",",
                     "invPe"}], "}"}], "\[Element]", "Reals"}], "}"}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                  RowBox[{"If", "[", 
                   RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{"value", "===", "0"}], "]"}], ",", 
                    RowBox[{"AppendTo", "[", 
                    RowBox[{"sparserules", ",", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"row", ",", "col"}], "}"}], "\[Rule]", 
                    "value"}]}], "]"}]}], "]"}], ";"}]}], 
                "\[IndentingNewLine]", "]"}], ";"}]}], "\[IndentingNewLine]", 
             "]"}], "\[IndentingNewLine]", 
            RowBox[{"row", "++"}]}], ";"}]}], "\[IndentingNewLine]", "]"}]}], 
       "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
      RowBox[{"SparseArray", "[", "sparserules", "]"}]}]}], 
    "\[IndentingNewLine]", "]"}]}], ";"}]], "Input",
 CellChangeTimes->{{3.579272683739621*^9, 3.5792728008693204`*^9}, {
   3.579272846947956*^9, 3.5792729117716637`*^9}, {3.5792738818061466`*^9, 
   3.5792739162531166`*^9}, 3.5792739481409407`*^9, {3.5792744372079134`*^9, 
   3.5792744482535458`*^9}, {3.579275308617756*^9, 3.579275332153102*^9}}]
}, Open  ]],

Cell[CellGroupData[{

Cell["Test it", "Subtitle",
 CellChangeTimes->{{3.5792731007734737`*^9, 3.579273105212728*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"maxl", "=", "4"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"sparsetest", " ", "=", " ", 
   RowBox[{"assemblesparse", "[", "maxl", "]"}]}], ";"}], "\n", 
 RowBox[{"ByteCount", "[", "sparsetest", "]"}], "\n", 
 RowBox[{"MatrixPlot", "[", "sparsetest", "]"}], "\[IndentingNewLine]", 
 RowBox[{"MatrixForm", "[", "sparsetest", "]"}]}], "Input",
 CellChangeTimes->{{3.579273106495801*^9, 3.5792731489972324`*^9}, {
  3.579273962479761*^9, 3.5792739733193808`*^9}, {3.5792740961584067`*^9, 
  3.5792741284782553`*^9}, {3.579275294565952*^9, 3.579275302333396*^9}}],

Cell[CellGroupData[{

Cell["Augmented matrix, even l,m", "Section",
 CellChangeTimes->{{3.5792741591580105`*^9, 3.579274167965514*^9}}],

Cell["\<\
Here we\[CloseCurlyQuote]ll save the real and imaginary parts of c_lm as \
separate elements, so if we want to we can export from mathematica and use \
any sparse solver we like.\
\>", "Text",
 CellChangeTimes->{{3.5792742514122868`*^9, 3.5792742540974407`*^9}, {
  3.579274295267795*^9, 3.5792743258925467`*^9}}],

Cell["\<\
sparseindex[l,m] gives the index of the real part of c_lm, the imaginary is \
the next index\
\>", "Text",
 CellChangeTimes->{{3.579274330443807*^9, 3.5792743513640037`*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"sparseindex", "[", 
    RowBox[{"l_Integer", ",", "m_Integer"}], "]"}], ":=", 
   RowBox[{
    RowBox[{"m", "+", 
     SuperscriptBox[
      RowBox[{"(", 
       FractionBox["l", "2"], ")"}], "2"], "-", 
     RowBox[{
      RowBox[{"(", 
       RowBox[{
        RowBox[{"-", "1"}], "+", "m"}], ")"}], " ", 
      RowBox[{"KroneckerDelta", "[", 
       RowBox[{"0", ",", "m"}], "]"}]}]}], "/;", 
    RowBox[{
     RowBox[{"EvenQ", "[", "l", "]"}], "&&", 
     RowBox[{"EvenQ", "[", "m", "]"}]}]}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"(*", " ", 
   RowBox[{
    RowBox[{
     RowBox[{"Computed", " ", 
      RowBox[{"from", ":", " ", 
       RowBox[{"sparseindex", "[", 
        RowBox[{"l_", ",", "m_"}], "]"}]}]}], ":=", " ", 
     RowBox[{"1", " ", "+", " ", 
      RowBox[{"Sum", "[", 
       RowBox[{
        RowBox[{"1", "+", "k"}], ",", 
        RowBox[{"{", 
         RowBox[{"k", ",", "0", ",", 
          RowBox[{"l", "-", "2"}], ",", "2"}], "}"}]}], "]"}], "+", 
      RowBox[{
       RowBox[{"(", 
        RowBox[{"1", "-", 
         RowBox[{"KroneckerDelta", "[", 
          RowBox[{"m", ",", "0"}], "]"}]}], ")"}], 
       RowBox[{"(", 
        RowBox[{"m", "-", "1"}], ")"}]}]}]}], ";"}], " ", "*)"}]}]}], "Input",
 CellChangeTimes->{{3.579274277502779*^9, 3.579274283773138*^9}}],

Cell["\<\
These are the functions that do the actual assembling.\
\>", "Text",
 CellChangeTimes->{{3.579274394355463*^9, 3.579274401523873*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{
   RowBox[{"AppendRules", "[", 
    RowBox[{"list_", ",", 
     RowBox[{"pos_", "\[Rule]", "val_"}]}], "]"}], ":=", 
   RowBox[{"Module", "[", 
    RowBox[{
     RowBox[{"{", "}"}], ",", "\[IndentingNewLine]", 
     RowBox[{
      RowBox[{"existingpos", "=", 
       RowBox[{"Position", "[", 
        RowBox[{"list", ",", 
         RowBox[{"pos", "\[Rule]", "_"}]}], "]"}]}], ";", 
      "\[IndentingNewLine]", 
      RowBox[{"If", "[", 
       RowBox[{
        RowBox[{
         RowBox[{"Length", "[", "existingpos", "]"}], "\[Equal]", "0"}], ",", 
        "\[IndentingNewLine]", 
        RowBox[{"Append", "[", 
         RowBox[{"list", ",", 
          RowBox[{"pos", "\[Rule]", "val"}]}], "]"}], ",", 
        "\[IndentingNewLine]", "\[IndentingNewLine]", 
        RowBox[{
         RowBox[{"existingpos", "=", 
          RowBox[{"existingpos", "[", 
           RowBox[{"[", 
            RowBox[{"1", ",", "1"}], "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"existingrule", " ", "=", " ", 
          RowBox[{"list", "[", 
           RowBox[{"[", "existingpos", "]"}], "]"}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"newrule", " ", "=", " ", 
          RowBox[{"existingrule", " ", "/.", 
           RowBox[{
            RowBox[{"(", 
             RowBox[{"pos", "\[Rule]", "x_"}], ")"}], "\[RuleDelayed]", 
            RowBox[{"(", 
             RowBox[{"pos", "\[Rule]", 
              RowBox[{"x", "+", "val"}]}], ")"}]}]}]}], ";", 
         "\[IndentingNewLine]", 
         RowBox[{"ReplacePart", "[", 
          RowBox[{"list", ",", 
           RowBox[{"existingpos", "\[Rule]", "newrule"}]}], "]"}]}]}], 
       "\[IndentingNewLine]", "]"}]}]}], "\[IndentingNewLine]", "]"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{
   RowBox[{"assemblesparseoptimised", "[", "maxl_", "]"}], ":=", 
   RowBox[{
    RowBox[{"Module", "[", 
     RowBox[{
      RowBox[{"{", 
       RowBox[{
       "row", ",", "p", ",", "q", ",", "col", ",", "dl", ",", "dm", ",", "l2",
         ",", "m2", ",", "sparserules", ",", "value", ",", "size", ",", "k", 
        ",", "delta", ",", "temprules", ",", "m2sign", ",", "m2magn", ",", 
        "recol", ",", "imcol", ",", "revalue", ",", "imvalue"}], "}"}], ",", 
      "\[IndentingNewLine]", 
      RowBox[{
       RowBox[{"size", " ", "=", 
        RowBox[{
         RowBox[{"sparseindex", "[", 
          RowBox[{"maxl", ",", "maxl"}], "]"}], "+", "1"}]}], ";", 
       "\[IndentingNewLine]", 
       RowBox[{"Print", "[", "size", "]"}], ";", "\[IndentingNewLine]", 
       RowBox[{"row", "=", "1"}], ";", "\[IndentingNewLine]", 
       RowBox[{"sparserules", "=", 
        RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
       RowBox[{"For", "[", 
        RowBox[{
         RowBox[{"p", "=", "0"}], ",", 
         RowBox[{"p", "<=", "maxl"}], ",", 
         RowBox[{"p", "+=", "2"}], ",", "\[IndentingNewLine]", 
         RowBox[{
          RowBox[{"For", "[", 
           RowBox[{
            RowBox[{"q", "=", "0"}], ",", 
            RowBox[{"q", "\[LessEqual]", "p"}], ",", 
            RowBox[{"q", "+=", "2"}], ",", "\[IndentingNewLine]", 
            RowBox[{
             RowBox[{"temprules", " ", "=", " ", 
              RowBox[{"{", "}"}]}], ";", "\[IndentingNewLine]", 
             RowBox[{"For", "[", 
              RowBox[{
               RowBox[{"k", "=", "1"}], ",", 
               RowBox[{"k", "\[LessEqual]", 
                RowBox[{"Length", "[", "matrixelements", "]"}]}], ",", 
               RowBox[{"k", "++"}], ",", "\[IndentingNewLine]", 
               RowBox[{
                RowBox[{"delta", "=", 
                 RowBox[{"matrixelements", "[", 
                  RowBox[{"[", 
                   RowBox[{"k", ",", "1"}], "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"dl", "=", 
                 RowBox[{"delta", "[", 
                  RowBox[{"[", "1", "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"dm", "=", 
                 RowBox[{"delta", "[", 
                  RowBox[{"[", "2", "]"}], "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"l2", "=", 
                 RowBox[{"p", "-", "dl"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"m2", " ", "=", " ", 
                 RowBox[{"q", "-", "dm"}]}], ";", "\[IndentingNewLine]", 
                RowBox[{"m2sign", " ", "=", " ", 
                 RowBox[{"Sign", "[", "m2", "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"m2magn", "=", 
                 RowBox[{"Abs", "[", "m2", "]"}]}], ";", 
                "\[IndentingNewLine]", 
                RowBox[{"If", " ", "[", 
                 RowBox[{
                  RowBox[{
                   RowBox[{"l2", "\[GreaterEqual]", "0"}], " ", "&&", " ", 
                   RowBox[{"l2", "\[LessEqual]", "maxl"}], "&&", 
                   RowBox[{
                    RowBox[{"Abs", "[", "m2", "]"}], "\[LessEqual]", "l2"}]}],
                   ",", "\[IndentingNewLine]", 
                  RowBox[{
                   RowBox[{"recol", " ", "=", " ", 
                    RowBox[{"sparseindex", "[", 
                    RowBox[{"l2", ",", "m2magn"}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"imcol", " ", "=", " ", 
                    RowBox[{"recol", "+", "1"}]}], ";", "\[IndentingNewLine]", 
                   RowBox[{"value", "=", 
                    RowBox[{"Simplify", "[", " ", 
                    RowBox[{
                    RowBox[{"matrixelements", "[", 
                    RowBox[{"[", 
                    RowBox[{"k", ",", "2"}], "]"}], "]"}], "/.", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"l", "\[Rule]", "l2"}], ",", 
                    RowBox[{"m", "\[Rule]", "m2"}]}], "}"}]}], "]"}]}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"revalue", "=", 
                    RowBox[{"Simplify", "[", 
                    RowBox[{
                    RowBox[{"Re", "[", "value", "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"\[CapitalLambda]", "\[Element]", "Reals"}], ",", 
                    RowBox[{"invPe", "\[Element]", "Reals"}], ",", 
                    RowBox[{"stEff", "\[Element]", "Reals"}]}], "}"}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                   RowBox[{"imvalue", "=", 
                    RowBox[{"Simplify", "[", 
                    RowBox[{
                    RowBox[{"Im", "[", "value", "]"}], ",", 
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"\[CapitalLambda]", "\[Element]", "Reals"}], ",", 
                    RowBox[{"invPe", "\[Element]", "Reals"}], ",", 
                    RowBox[{"stEff", "\[Element]", "Reals"}]}], "}"}]}], 
                    "]"}]}], ";", "\[IndentingNewLine]", 
                   RowBox[{"(*", 
                    RowBox[{"Row", " ", "for", " ", "real", " ", "value"}], 
                    "*)"}], "\[IndentingNewLine]", "\[IndentingNewLine]", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{"revalue", "===", "0"}], "]"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"temprules", "=", 
                    RowBox[{"AppendRules", "[", 
                    RowBox[{"temprules", ",", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"row", ",", "recol"}], "}"}], "\[Rule]", 
                    "revalue"}]}], "]"}]}], ";"}]}], "\[IndentingNewLine]", 
                    "]"}], ";", "\[IndentingNewLine]", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{"imvalue", "===", "0"}], "]"}], "&&", 
                    RowBox[{"Not", "[", 
                    RowBox[{"m2", "\[Equal]", "0"}], "]"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"temprules", "=", 
                    RowBox[{"AppendRules", "[", 
                    RowBox[{"temprules", ",", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{"row", ",", "imcol"}], "}"}], "\[Rule]", 
                    RowBox[{
                    RowBox[{"-", "imvalue"}], " ", "m2sign"}]}]}], "]"}]}], 
                    ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
                   "\[IndentingNewLine]", 
                   RowBox[{"(*", 
                    RowBox[{
                    "Row", " ", "for", " ", "imaginory", " ", "value"}], 
                    "*)"}], "\[IndentingNewLine]", 
                   RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{"q", "\[Equal]", "0"}], "]"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{"revalue", "===", "0"}], "]"}], "&&", 
                    RowBox[{"Not", "[", 
                    RowBox[{"m2", "\[Equal]", "0"}], "]"}]}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"temprules", "=", 
                    RowBox[{"AppendRules", "[", 
                    RowBox[{"temprules", ",", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"row", "+", "1"}], ",", "imcol"}], "}"}], 
                    "\[Rule]", 
                    RowBox[{"revalue", " ", "m2sign"}]}]}], "]"}]}], ";"}]}], 
                    "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
                    RowBox[{"If", "[", 
                    RowBox[{
                    RowBox[{"Not", "[", 
                    RowBox[{"imvalue", "===", "0"}], "]"}], ",", 
                    "\[IndentingNewLine]", 
                    RowBox[{
                    RowBox[{"temprules", "=", 
                    RowBox[{"AppendRules", "[", 
                    RowBox[{"temprules", ",", 
                    RowBox[{
                    RowBox[{"{", 
                    RowBox[{
                    RowBox[{"row", "+", "1"}], ",", "recol"}], "}"}], 
                    "\[Rule]", "imvalue"}]}], "]"}]}], ";"}]}], 
                    "\[IndentingNewLine]", "]"}], ";"}]}], 
                    "\[IndentingNewLine]", "]"}], ";"}]}], 
                 "\[IndentingNewLine]", "\[IndentingNewLine]", "]"}], ";"}]}],
               "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
             RowBox[{"sparserules", " ", "=", " ", 
              RowBox[{"Join", "[", 
               RowBox[{"sparserules", ",", "temprules"}], "]"}]}], ";", 
             "\[IndentingNewLine]", 
             RowBox[{"row", "+=", 
              RowBox[{"If", "[", 
               RowBox[{
                RowBox[{"q", "\[Equal]", "0"}], ",", "1", ",", "2"}], "]"}]}],
              ";"}]}], "\[IndentingNewLine]", "]"}], ";", 
          "\[IndentingNewLine]", 
          RowBox[{"PrintTemporary", "[", "p", "]"}]}]}], 
        "\[IndentingNewLine]", "]"}], ";", "\[IndentingNewLine]", 
       "\[IndentingNewLine]", 
       RowBox[{"SparseArray", "[", "sparserules", "]"}]}]}], 
     "\[IndentingNewLine]", "]"}], "/;", 
    RowBox[{"EvenQ", "[", "maxl", "]"}]}]}], ";"}]}], "Input",
 CellChangeTimes->{{3.5792743884931273`*^9, 3.579274389455182*^9}, {
  3.579275360476722*^9, 3.579275389501382*^9}}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["Test it", "Subtitle",
 CellChangeTimes->{{3.5792754862679167`*^9, 3.579275489708113*^9}}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"maxl", "=", "12"}], ";"}], "\n", 
 RowBox[{
  RowBox[{"sparsetest", " ", "=", " ", 
   RowBox[{"assemblesparseoptimised", "[", "maxl", "]"}]}], ";"}], "\n", 
 RowBox[{"ByteCount", "[", "sparsetest", "]"}], "\n", 
 RowBox[{"MatrixPlot", "[", "sparsetest", "]"}], "\n", 
 RowBox[{
  RowBox[{"(*", 
   RowBox[{"MatrixForm", "[", "sparsetest", "]"}], "*)"}]}]}], "Input",
 CellChangeTimes->{{3.579275491119194*^9, 3.5792755117643747`*^9}}],

Cell[CellGroupData[{

Cell[TextData[StyleBox["Assemble up to some size, and save it to a .mx file \
(platform specific, dont transfer .mx around)", "Section"]], "Section",
 CellChangeTimes->{3.5792758843376846`*^9}],

Cell[BoxData[{
 RowBox[{
  RowBox[{"maxl", " ", "=", " ", "100"}], ";"}], "\[IndentingNewLine]", 
 RowBox[{"sparseOptimised", "=", 
  RowBox[{
  "assemblesparseoptimised", "[", "maxl", "]"}]}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"sparseAugmented", " ", "=", " ", 
   RowBox[{"sparseOptimised", "[", 
    RowBox[{"[", 
     RowBox[{
      RowBox[{"2", ";;"}], ",", 
      RowBox[{"2", ";;"}]}], "]"}], "]"}]}], ";"}], "\[IndentingNewLine]", 
 RowBox[{
  RowBox[{"augmentedB", "=", 
   RowBox[{
    RowBox[{
     RowBox[{"-", 
      RowBox[{"sparseOptimised", "[", 
       RowBox[{"[", 
        RowBox[{
         RowBox[{"2", ";;"}], ",", "1"}], "]"}], "]"}]}], " ", "*", " ", 
     RowBox[{"1", "/", 
      RowBox[{"(", 
       RowBox[{"2", " ", 
        RowBox[{"Sqrt", "[", "Pi", "]"}]}], ")"}]}]}], "//", "Normal"}]}], 
  ";"}], "\[IndentingNewLine]", 
 RowBox[{"DumpSave", "[", 
  RowBox[{
   RowBox[{"ToString", "[", 
    RowBox[{"StringForm", "[", 
     RowBox[{"\"\<augmentedMatrix_lmax``.mx\>\"", ",", "maxl"}], "]"}], "]"}],
    ",", 
   RowBox[{"{", 
    RowBox[{"sparseAugmented", ",", "augmentedB"}], "}"}]}], "]"}]}], "Input",
 CellChangeTimes->{{3.579275533812636*^9, 3.5792756206846046`*^9}, {
  3.5792756819641094`*^9, 3.579275728755786*^9}, {3.579275795683614*^9, 
  3.579275801018919*^9}, {3.5793505106440654`*^9, 3.579350514676296*^9}}],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.579275657354702*^9, 3.5792756655401707`*^9}, 
   3.5792757234824843`*^9}]
}, Open  ]]
}, Open  ]],

Cell[CellGroupData[{

Cell["See if it works", "Subtitle",
 CellChangeTimes->{{3.579275904464836*^9, 3.5792759068489723`*^9}}],

Cell[BoxData[{
 RowBox[{"Clear", "[", 
  RowBox[{"sparseAugmented", ",", "augmentedB"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Get", "[", 
  RowBox[{"ToString", "[", 
   RowBox[{"StringForm", "[", 
    RowBox[{"\"\<augmentedMatrix_lmax``.mx\>\"", ",", "maxl"}], "]"}], "]"}], 
  "]"}], "\[IndentingNewLine]", 
 RowBox[{"Dimensions", "[", "sparseAugmented", "]"}], "\[IndentingNewLine]", 
 RowBox[{"MatrixPlot", "[", "sparseAugmented", "]"}]}], "Input",
 CellChangeTimes->{{3.5792758134396296`*^9, 3.579275848897658*^9}, {
  3.5792759091221027`*^9, 3.5792759150494413`*^9}}],

Cell[BoxData[""], "Input",
 CellChangeTimes->{{3.57927584071019*^9, 3.5792758414582324`*^9}}]
}, Open  ]]
}, Open  ]]
},
Evaluator->"Sixth",
WindowSize->{1241, 947},
WindowMargins->{{271, Automatic}, {Automatic, 178}},
FrontEndVersion->"9.0 for Microsoft Windows (64-bit) (November 20, 2012)",
StyleDefinitions->"Default.nb"
]
(* End of Notebook Content *)

(* Internal cache information *)
(*CellTagsOutline
CellTagsIndex->{}
*)
(*CellTagsIndex
CellTagsIndex->{}
*)
(*NotebookFileOutline
Notebook[{
Cell[CellGroupData[{
Cell[579, 22, 142, 3, 90, "Title"],
Cell[724, 27, 430, 8, 85, "Subsubtitle"],
Cell[1157, 37, 359, 7, 68, "Text"],
Cell[CellGroupData[{
Cell[1541, 48, 143, 3, 79, "Section"],
Cell[1687, 53, 169, 3, 30, "Text"],
Cell[1859, 58, 30317, 791, 662, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[32213, 854, 115, 1, 79, "Section"],
Cell[32331, 857, 5052, 111, 492, "Input"]
}, Open  ]],
Cell[CellGroupData[{
Cell[37420, 973, 95, 1, 49, "Subtitle"],
Cell[37518, 976, 589, 11, 112, "Input"],
Cell[CellGroupData[{
Cell[38132, 991, 113, 1, 79, "Section"],
Cell[38248, 994, 323, 6, 30, "Text"],
Cell[38574, 1002, 184, 4, 30, "Text"],
Cell[38761, 1008, 1359, 41, 69, "Input"],
Cell[40123, 1051, 144, 3, 30, "Text"],
Cell[40270, 1056, 11870, 261, 1252, "Input"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[52189, 1323, 95, 1, 49, "Subtitle"],
Cell[52287, 1326, 471, 11, 112, "Input"],
Cell[CellGroupData[{
Cell[52783, 1341, 193, 2, 113, "Section"],
Cell[52979, 1345, 1363, 37, 112, "Input"],
Cell[54345, 1384, 122, 2, 31, "Input"]
}, Open  ]]
}, Open  ]],
Cell[CellGroupData[{
Cell[54516, 1392, 103, 1, 49, "Subtitle"],
Cell[54622, 1395, 579, 12, 92, "Input"],
Cell[55204, 1409, 93, 1, 31, "Input"]
}, Open  ]]
}, Open  ]]
}
]
*)

(* End of internal cache information *)
